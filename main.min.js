function init(){function e(e){var t='<li class = "review-list-item"><strong class="reviewer-name">'+e.name+' </strong><span class="review-place">'+e.place+' </span><span class="review-date">'+new Date(e.date).toLocaleDateString()+' </span><span class="review-text">'+e.text+"<span></li>";return t}var t,n=new ymaps.Map("map",{center:[55.753994,37.622093],zoom:9},{searchControlProvider:"yandex#search"});BalloonContentLayout=ymaps.templateLayoutFactory.createClass('<div class="mr-wrapper"><header class="review-header"><span class="header-adress">{{properties.address}}</span><div class="x-wrapper"><a id = "closeBalloon"href="#"><img src="img/x.png" alt="review-close"></a></div></header><div class="review-list-wrapper"><ul id="rl" class="review-list"></ul><hr></div><div class="review-form-wrapper"><form name="newReview" class="review-add__form"><span class="form-header">Ваш отзыв</span><input type="text" name="name" placeholder="Ваше имя" class="review-add__input"><input type="text" name="place" placeholder="Укажите место" class="review-add__input"><textarea type="text" name="text" placeholder="Поделитесь впечатлениями" class="review-add__textarea"></textarea><a id="sendReview" href="#" class="review-add__button">Добавить</a></form></div></div></div>');var o=ymaps.templateLayoutFactory.createClass("<span class=ballon_header>{{ properties.balloonContentHeader|raw }}</span><div class=ballon_body>{{ properties.balloonContentBody|raw }}</div><div class=ballon_footer>{{ properties.balloonContentFooter|raw }}</div>"),a=new ymaps.Clusterer({clusterDisableClickZoom:!0,clusterOpenBalloonOnClick:!0,clusterBalloonContentLayout:"cluster#balloonCarousel",clusterBalloonItemContentLayout:o,clusterBalloonPanelMaxMapArea:0,clusterBalloonContentLayoutWidth:200,clusterBalloonContentLayoutHeight:130,clusterBalloonPagerSize:5});n.geoObjects.add(a);var s=new XMLHttpRequest,r=JSON.stringify({op:"all"});s.open("POST","http://localhost:3000"),s.responseType="json",s.send(r),s.onloadend=function(){for(var n in s.response)s.response[n].forEach(function(o){ymaps.geocode(n,{results:1}).then(function(n){var s=n.geoObjects.get(0),r=s.geometry.getCoordinates();t=new ymaps.Placemark(r,{address:s.properties.get("name"),balloonContentHeader:s.properties.get("name"),balloonContentBody:o.name+" - "+o.place+" <br>"+new Date(o.date).toLocaleDateString(),balloonContentFooter:o.text},{balloonContentLayout:BalloonContentLayout,balloonPanelMaxMapArea:0}),a.add(t),t.events.add("click",function(){setTimeout(function(){var t=document.getElementById("rl"),n=new XMLHttpRequest,o=JSON.stringify({op:"get",address:s.getAddressLine()});n.open("POST","http://localhost:3000"),n.responseType="json",n.send(o),n.onloadend=function(){for(var o=0;o<n.response.length;o++){var a=e(n.response[o]);t.innerHTML=null,t.innerHTML+=a}}},200)})})})},n.events.add("click",function(n){var o=n.get("coords");ymaps.geocode(o).then(function(e){return new Promise(function(t){var n=e.geoObjects.get(0);t(n)})}).then(function(n){t=new ymaps.Placemark(o,{address:n.properties.get("name")},{balloonContentLayout:BalloonContentLayout,balloonPanelMaxMapArea:0}),a.add(t),t.events.add("click",function(){setTimeout(function(){var t=document.getElementById("rl"),o=new XMLHttpRequest,a=JSON.stringify({op:"get",address:n.getAddressLine()});o.open("POST","http://localhost:3000"),o.responseType="json",o.send(a),o.onloadend=function(){for(var n=0;n<o.response.length;n++){var a=e(o.response[n]);t.innerHTML+=a}}},200)}),document.addEventListener("click",function(t){if("sendReview"==t.target.id){t.preventDefault();var a=newReview.name.value,s=newReview.place.value,r=newReview.text.value,l=new Date;if(l=l.toLocaleString(),0===a.length||0===s.length||0===r.length)alert("Вы не написали отзыв!");else{var i=new XMLHttpRequest,d={op:"add",review:{coords:{x:o[0],y:o[1]},address:n.getAddressLine(),name:a,place:s,text:r,date:Date.now()}};d=JSON.stringify(d),i.open("POST","http://localhost:3000"),i.send(d);var c=document.getElementById("rl"),p=e(JSON.parse(d).review);c.innerHTML+=p,alert("Ваш отзыв успешно добавлен!")}}})})})}ymaps.ready(init);
